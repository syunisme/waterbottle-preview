<script>
const canvas = document.getElementById("designCanvas");
const ctx = canvas.getContext("2d");
const bottle = document.getElementById("bottle");
const imgUpload = document.getElementById("imgUpload");
const textInput = document.getElementById("textInput");
const clearBtn = document.getElementById("clearBtn");

const colorBody = document.getElementById("colorBody");
const colorCap = document.getElementById("colorCap");
const colorHandle = document.getElementById("colorHandle");

let uploadedImg = null;


// --------------------------------------------------------
// ★ Canvas 大小永遠跟圖片顯示大小一樣（最重要修正）
// --------------------------------------------------------
function resizeCanvasToBottle() {
  const rect = bottle.getBoundingClientRect();
  canvas.width = rect.width;
  canvas.height = rect.height;
  redrawAll();
}

bottle.onload = resizeCanvasToBottle;
window.addEventListener("resize", resizeCanvasToBottle);


// --------------------------------------------------------
// 主要重新渲染函式
// --------------------------------------------------------
function redrawAll() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const scale = canvas.width / 300;  
  ctx.save();
  ctx.scale(scale, scale);

  drawColorAreas();

  // 上傳圖片
  if (uploadedImg) {
    ctx.drawImage(uploadedImg, 90, 180, 130, 130);
  }

  // 文字
  if (textInput.value) {
    ctx.font = "24px sans-serif";
    ctx.fillStyle = "black";
    ctx.fillText(textInput.value, 90, 340);
  }

  ctx.restore();
}


// --------------------------------------------------------
// 分區著色（曲線版）
// --------------------------------------------------------
function drawColorAreas() {

  // 1) 曲線瓶蓋
  ctx.save();
  pathCap(ctx);
  ctx.clip();
  ctx.fillStyle = colorCap.value + "88";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.restore();

  // 2) 曲線瓶身
  ctx.save();
  pathBody(ctx);
  ctx.clip();
  ctx.fillStyle = colorBody.value + "77";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.restore();

  // 3) 提帶 + 圓環
  ctx.save();
  pathStrap(ctx);
  ctx.clip();
  ctx.fillStyle = colorHandle.value + "99";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.restore();
}


// --------------------------------------------------------
// Path（依照你圖片量好的座標）
// --------------------------------------------------------

// ① 瓶蓋
function pathCap(ctx) {
  ctx.beginPath();
  ctx.moveTo(90, 40);
  ctx.quadraticCurveTo(150, -10, 210, 40);
  ctx.quadraticCurveTo(230, 90, 210, 130);
  ctx.lineTo(90, 130);
  ctx.quadraticCurveTo(70, 90, 90, 40);
  ctx.closePath();
}

// ② 瓶身
function pathBody(ctx) {
  ctx.beginPath();
  ctx.moveTo(70, 140);
  ctx.quadraticCurveTo(55, 170, 55, 210);
  ctx.lineTo(55, 500);
  ctx.quadraticCurveTo(55, 540, 90, 560);

  ctx.lineTo(215, 560);
  ctx.quadraticCurveTo(245, 540, 245, 500);
  ctx.lineTo(245, 210);
  ctx.quadraticCurveTo(245, 170, 230, 140);
  ctx.closePath();
}

// ③ 提帶 + 圓環
function pathStrap(ctx) {
  ctx.beginPath();

  // 直條帶子
  ctx.moveTo(150, 180);
  ctx.lineTo(172, 180);
  ctx.lineTo(172, 430);
  ctx.lineTo(150, 430);
  ctx.closePath();

  // 上方小圈
  ctx.moveTo(161, 435);
  ctx.arc(161, 460, 25, 0, Math.PI * 2);

  // 下方大圈
  ctx.moveTo(161, 515);
  ctx.arc(161, 515, 35, 0, Math.PI * 2);
}


// --------------------------------------------------------
// 綁定事件
// --------------------------------------------------------
colorBody.addEventListener("input", redrawAll);
colorCap.addEventListener("input", redrawAll);
colorHandle.addEventListener("input", redrawAll);

imgUpload.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const img = new Image();
  img.onload = () => {
    uploadedImg = img;
    redrawAll();
  };
  img.src = URL.createObjectURL(file);
});

textInput.addEventListener("input", redrawAll);

clearBtn.addEventListener("click", () => {
  uploadedImg = null;
  textInput.value = "";
  redrawAll();
});
</script>
